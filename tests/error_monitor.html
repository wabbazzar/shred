<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Monitor - 6-Week Shred Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: #121212;
            color: #fff;
        }
        .monitor-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .monitor-header {
            background: #1E1E1E;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .monitor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .monitor-panel {
            background: #1E1E1E;
            border-radius: 8px;
            overflow: hidden;
        }
        .panel-header {
            background: #FF6B00;
            color: #121212;
            padding: 15px;
            font-weight: bold;
        }
        .panel-content {
            padding: 15px;
        }
        .app-frame {
            width: 100%;
            height: 600px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #000;
        }
        .console-output {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #333;
            border-radius: 4px;
        }
        .error-log {
            background: #2D1B1B;
            color: #ff6b6b;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #ff6b6b;
            border-radius: 4px;
            margin: 10px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .btn {
            background: #FF6B00;
            color: #121212;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn:hover {
            background: #e55a00;
        }
        .btn.danger {
            background: #FF5252;
        }
        .btn.success {
            background: #00C851;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.ok {
            background: #00C851;
        }
        .status-indicator.error {
            background: #FF5252;
        }
        .status-indicator.warning {
            background: #FF6B00;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .view-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .view-card {
            background: #2D2D2D;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }
        .view-card.error {
            border-color: #FF5252;
            background: #2D1B1B;
        }
        .view-card.ok {
            border-color: #00C851;
            background: #1B2D1B;
        }
    </style>
</head>
<body>
    <div class="monitor-container">
        <div class="monitor-header">
            <h1>üîç 6-Week Shred Error Monitor</h1>
            <p>Real-time debugging and error tracking</p>
        </div>

        <div class="monitor-grid">
            <!-- Live App Frame -->
            <div class="monitor-panel">
                <div class="panel-header">
                    <span class="status-indicator" id="app-status"></span>
                    Live App - Calendar View
                </div>
                <div class="panel-content">
                    <div class="controls">
                        <button class="btn" onclick="reloadApp()">Reload App</button>
                        <button class="btn" onclick="switchToDay()">Day View</button>
                        <button class="btn" onclick="switchToWeek()">Week View</button>
                        <button class="btn" onclick="switchToCalendar()">Calendar View</button>
                    </div>
                    <iframe id="app-frame" class="app-frame" src="../index.html#calendar"></iframe>
                </div>
            </div>

            <!-- Console Output -->
            <div class="monitor-panel">
                <div class="panel-header">
                    <span class="status-indicator ok"></span>
                    Console Output
                </div>
                <div class="panel-content">
                    <div class="controls">
                        <button class="btn" onclick="clearConsole()">Clear Console</button>
                        <button class="btn" onclick="exportLogs()">Export Logs</button>
                    </div>
                    <div id="console-output" class="console-output">Monitoring console output...</div>
                </div>
            </div>

            <!-- Error Log -->
            <div class="monitor-panel">
                <div class="panel-header">
                    <span class="status-indicator" id="error-status"></span>
                    JavaScript Errors
                </div>
                <div class="panel-content">
                    <div class="controls">
                        <button class="btn danger" onclick="clearErrors()">Clear Errors</button>
                        <button class="btn" onclick="testErrorHandling()">Test Error Handling</button>
                    </div>
                    <div id="error-output" class="error-log">No errors detected...</div>
                </div>
            </div>

            <!-- View Status -->
            <div class="monitor-panel">
                <div class="panel-header">
                    <span class="status-indicator" id="views-status"></span>
                    View Status Monitor
                </div>
                <div class="panel-content">
                    <div class="view-status">
                        <div class="view-card" id="day-view-card">
                            <h4>üìÖ Day View</h4>
                            <p id="day-view-status">Checking...</p>
                        </div>
                        <div class="view-card" id="week-view-card">
                            <h4>üìã Week View</h4>
                            <p id="week-view-status">Checking...</p>
                        </div>
                        <div class="view-card" id="calendar-view-card">
                            <h4>üóìÔ∏è Calendar View</h4>
                            <p id="calendar-view-status">Checking...</p>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn" onclick="checkAllViews()">Check All Views</button>
                        <button class="btn" onclick="debugTuesday()">Debug Tuesday</button>
                        <button class="btn danger" onclick="clearAllData()">Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Full-width debug panel -->
        <div class="monitor-panel full-width">
            <div class="panel-header">
                <span class="status-indicator warning"></span>
                Debug Commands & Storage Inspector
            </div>
            <div class="panel-content">
                <div class="controls">
                    <button class="btn" onclick="inspectStorage()">Inspect Storage</button>
                    <button class="btn" onclick="debugDateCalculation()">Debug Date Calculation</button>
                    <button class="btn" onclick="testTodayLogic()">Test Today Logic</button>
                    <button class="btn success" onclick="runFullDiagnostic()">Full Diagnostic</button>
                </div>
                <div id="debug-output" class="console-output">Debug output will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        let errorCount = 0;
        let consoleMessages = [];
        let errors = [];

        // Override console methods to capture output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        function logToMonitor(type, args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = Array.from(args).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            consoleMessages.push(logEntry);

            const consoleOutput = document.getElementById('console-output');
            consoleOutput.textContent += logEntry + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;

            // Call original method
            originalConsole[type]?.apply(console, args);
        }

        console.log = (...args) => logToMonitor('log', args);
        console.error = (...args) => {
            logToMonitor('error', args);
            addError('Console Error', args.join(' '));
        };
        console.warn = (...args) => logToMonitor('warn', args);

        // Capture JavaScript errors
        window.addEventListener('error', (event) => {
            addError('JavaScript Error', `${event.message} at ${event.filename}:${event.lineno}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            addError('Unhandled Promise Rejection', event.reason);
        });

        function addError(type, message) {
            errorCount++;
            const timestamp = new Date().toLocaleTimeString();
            const errorEntry = `[${timestamp}] ${type}: ${message}`;
            errors.push(errorEntry);

            const errorOutput = document.getElementById('error-output');
            errorOutput.textContent += errorEntry + '\n';
            errorOutput.scrollTop = errorOutput.scrollHeight;

            updateErrorStatus();
        }

        function updateErrorStatus() {
            const errorStatus = document.getElementById('error-status');
            if (errorCount === 0) {
                errorStatus.className = 'status-indicator ok';
            } else {
                errorStatus.className = 'status-indicator error';
            }
        }

        // Control functions
        function reloadApp() {
            const frame = document.getElementById('app-frame');
            frame.src = frame.src;
            updateViewStatus('Reloading app...', 'warning');
        }

        function switchToDay() {
            const frame = document.getElementById('app-frame');
            frame.src = '../index.html#day';
            updateViewStatus('Switching to Day view...', 'warning');
        }

        function switchToWeek() {
            const frame = document.getElementById('app-frame');
            frame.src = '../index.html#week';
            updateViewStatus('Switching to Week view...', 'warning');
        }

        function switchToCalendar() {
            const frame = document.getElementById('app-frame');
            frame.src = '../index.html#calendar';
            updateViewStatus('Switching to Calendar view...', 'warning');
        }

        function clearConsole() {
            document.getElementById('console-output').textContent = '';
            consoleMessages = [];
        }

        function clearErrors() {
            document.getElementById('error-output').textContent = 'No errors detected...';
            errors = [];
            errorCount = 0;
            updateErrorStatus();
        }

        function updateViewStatus(message, status) {
            const appStatus = document.getElementById('app-status');
            appStatus.className = `status-indicator ${status}`;
        }

        function checkAllViews() {
            const views = ['day', 'week', 'calendar'];
            views.forEach((view, index) => {
                setTimeout(() => {
                    const frame = document.getElementById('app-frame');
                    frame.src = `../index.html#${view}`;
                    
                    setTimeout(() => {
                        checkViewStatus(view);
                    }, 1000);
                }, index * 2000);
            });
        }

        function checkViewStatus(viewName) {
            const card = document.getElementById(`${viewName}-view-card`);
            const status = document.getElementById(`${viewName}-view-status`);
            
            // Simulate checking view (in real implementation, would check iframe content)
            setTimeout(() => {
                if (errorCount === 0) {
                    card.className = 'view-card ok';
                    status.textContent = 'Working ‚úì';
                } else {
                    card.className = 'view-card error';
                    status.textContent = 'Has Errors ‚úó';
                }
            }, 500);
        }

        function debugTuesday() {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent += '\n=== TUESDAY DEBUG SESSION ===\n';
            debugOutput.textContent += 'Checking Tuesday status across all views...\n';
            debugOutput.textContent += 'Today is: ' + new Date().toDateString() + '\n';
            debugOutput.textContent += 'Local time: ' + new Date().toLocaleTimeString() + '\n';
            
            // Try to send debug command to app
            try {
                const frame = document.getElementById('app-frame');
                frame.contentWindow.postMessage({
                    type: 'debug',
                    command: 'debugDayConsistency',
                    params: [2]
                }, '*');
            } catch (error) {
                debugOutput.textContent += 'Error sending debug command: ' + error.message + '\n';
            }
        }

        function inspectStorage() {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent += '\n=== LOCAL STORAGE INSPECTION ===\n';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                debugOutput.textContent += `${key}: ${value.substring(0, 100)}...\n`;
            }
        }

        function debugDateCalculation() {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent += '\n=== DATE CALCULATION DEBUG ===\n';
            
            const today = new Date();
            debugOutput.textContent += `Today: ${today.toDateString()}\n`;
            debugOutput.textContent += `Day of week: ${today.getDay()} (0=Sunday)\n`;
            debugOutput.textContent += `ISO String: ${today.toISOString()}\n`;
            debugOutput.textContent += `Local date string: ${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}\n`;
        }

        function testTodayLogic() {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent += '\n=== TODAY LOGIC TEST ===\n';
            
            // Test the date logic manually
            const today = new Date();
            const startDateStr = '2024-07-11'; // Example start date
            const [year, month, day] = startDateStr.split('-').map(Number);
            const programStart = new Date(year, month - 1, day);
            
            const daysDiff = Math.floor((today - programStart) / (1000 * 60 * 60 * 24));
            const currentWeek = Math.floor(daysDiff / 7) + 1;
            const currentDay = (daysDiff % 7) + 1;
            
            debugOutput.textContent += `Program start: ${programStart.toDateString()}\n`;
            debugOutput.textContent += `Days since start: ${daysDiff}\n`;
            debugOutput.textContent += `Calculated week: ${currentWeek}\n`;
            debugOutput.textContent += `Calculated day: ${currentDay}\n`;
        }

        function runFullDiagnostic() {
            clearConsole();
            clearErrors();
            
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent = '=== FULL DIAGNOSTIC STARTING ===\n';
            
            // Run all diagnostic functions
            setTimeout(() => debugDateCalculation(), 500);
            setTimeout(() => testTodayLogic(), 1000);
            setTimeout(() => inspectStorage(), 1500);
            setTimeout(() => debugTuesday(), 2000);
            setTimeout(() => checkAllViews(), 2500);
        }

        function exportLogs() {
            const allLogs = {
                timestamp: new Date().toISOString(),
                consoleMessages,
                errors,
                localStorage: Object.fromEntries(
                    Array.from({ length: localStorage.length }, (_, i) => {
                        const key = localStorage.key(i);
                        return [key, localStorage.getItem(key)];
                    })
                )
            };

            const blob = new Blob([JSON.stringify(allLogs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout-app-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('This will clear all app data and reload. Continue?')) {
                localStorage.clear();
                reloadApp();
                clearConsole();
                clearErrors();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateErrorStatus();
            updateViewStatus('Loading...', 'warning');
            
            // Auto-run diagnostic after 3 seconds
            setTimeout(runFullDiagnostic, 3000);
        });
    </script>
</body>
</html>